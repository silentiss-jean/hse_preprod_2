# -*- coding: utf-8 -*-
"""Plateforme sensor pour Home Suivi Ã‰lec â€” Phase 3.0."""

import logging
from homeassistant.core import HomeAssistant
from homeassistant.config_entries import ConfigEntry
from homeassistant.helpers.entity_platform import AddEntitiesCallback

from .const import DOMAIN

LOGGER = logging.getLogger(__name__)


async def async_setup_entry(
    hass: HomeAssistant,
    entry: ConfigEntry,
    async_add_entities: AddEntitiesCallback,
) -> None:
    """Set up sensors from a config entry â€” Phase 3: EVENT-DRIVEN.

    ğŸš€ NOUVELLE ARCHITECTURE: Les sensors sont ajoutÃ©s via events au lieu du setup timing.
    
    Events Ã©coutÃ©s:
      - 'hse_energy_sensors_ready'       : sensors energy cycles (energy_tracking.py)  
      - 'hse_power_sensors_ready'        : sensors power temps rÃ©el (power_monitoring.py)
      - 'hse_power_energy_sensors_ready' : sensors energy cycles depuis power (power_monitoring.py)
    """
    from homeassistant.core import callback
    
    LOGGER.info("ğŸ¯ [EVENT-DRIVEN] Setup sensor platform - Attente events...")
    
    @callback
    def on_hse_sensors_ready(event):
        """Callback unifiÃ© pour tous les events HSE sensors."""
        try:
            # âœ… RÃ©cupÃ©rer depuis hass.data au lieu de l'event
            sensor_type = event.data.get('type', 'unknown')
            count = event.data.get('count', 0)
            timestamp = event.data.get('timestamp', 'unknown')
            
            LOGGER.info(f"ğŸ“¡ [EVENT REÃ‡U] {sensor_type.upper()}: {count} sensors Ã  ajouter")
            LOGGER.debug(f"ğŸ•’ [EVENT] Timestamp: {timestamp}")
        
            # RÃ©cupÃ©rer les sensors depuis hass.data (pas depuis l'event)
            if sensor_type == 'energy':
                sensors = hass.data.get(DOMAIN, {}).get("energy_sensors", [])
            elif sensor_type == 'power':
                sensors = hass.data.get(DOMAIN, {}).get("live_power_sensors", [])
            elif sensor_type == 'power_energy':  # âœ… NOUVEAU
                sensors = hass.data.get(DOMAIN, {}).get("power_energy_sensors", [])
            else:
                LOGGER.warning(f"âš ï¸ [EVENT] Type inconnu: {sensor_type}")
                return
        
            if sensors:
                # Ajouter immÃ©diatement les sensors reÃ§us
                async_add_entities(sensors, True)
                LOGGER.info(f"âœ… [EVENT-PROCESSED] {len(sensors)} sensors {sensor_type} enregistrÃ©s")
            else:
                LOGGER.warning(f"âš ï¸ [EVENT] Aucun sensor dans hass.data pour type {sensor_type}")
            
        except Exception as e:
            LOGGER.exception(f"âŒ [EVENT-ERROR] Erreur traitement event: {e}")

    
    # Setup listeners pour tous les events HSE
    hass.bus.async_listen('hse_energy_sensors_ready', on_hse_sensors_ready)
    hass.bus.async_listen('hse_power_sensors_ready', on_hse_sensors_ready)
    hass.bus.async_listen('hse_power_energy_sensors_ready', on_hse_sensors_ready)  # âœ… NOUVEAU
    
    LOGGER.info("ğŸ§ [EVENT-DRIVEN] Listeners activÃ©s - En attente des events sensors...")
    
    # ğŸ¯ BACKUP: VÃ©rifier si sensors dÃ©jÃ  prÃ©sents (cas de redÃ©marrage)
    energy_sensors = hass.data.get(DOMAIN, {}).get("energy_sensors", [])
    live_power_sensors = hass.data.get(DOMAIN, {}).get("live_power_sensors", [])
    power_energy_sensors = hass.data.get(DOMAIN, {}).get("power_energy_sensors", [])  # âœ… NOUVEAU
    
    if energy_sensors or live_power_sensors or power_energy_sensors:
        total = len(energy_sensors) + len(live_power_sensors) + len(power_energy_sensors)
        LOGGER.info(
            f"ğŸ”„ [BACKUP] Sensors dÃ©jÃ  prÃ©sents: "
            f"{len(energy_sensors)} energy + "
            f"{len(live_power_sensors)} power + "
            f"{len(power_energy_sensors)} power_energy"
        )
        async_add_entities(energy_sensors + live_power_sensors + power_energy_sensors, True)
        LOGGER.info(f"âœ… [BACKUP] {total} sensors prÃ©-existants enregistrÃ©s")
