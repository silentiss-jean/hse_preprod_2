"use strict";

/**
 * Calculateur de prix et abonnements
 * Gère les tarifs fixe et HP/HC
 */

// Périodes de consommation
export const PERIODS = [
    { label: 'Heure', key: 'hourly', abDiv: 30 * 24 },
    { label: 'Jour', key: 'daily', abDiv: 30 },
    { label: 'Semaine', key: 'weekly', abDiv: 4.345 },
    { label: 'Mois', key: 'monthly', abDiv: 1 },
    { label: 'Année', key: 'yearly', abDiv: 1 / 12 }
];

/**
 * Calcule l'abonnement HT pour une période donnée
 * @param {Object} userData - Options utilisateur
 * @param {number} periodIdx - Index de la période (0-4)
 * @returns {number} Montant HT de l'abonnement
 */
export function getAbonnementHT(userData, periodIdx) {
    const v = Number(userData.abonnementHT ?? userData.abonnementht ?? 0);
    const { abDiv } = PERIODS[periodIdx];
    
    if (abDiv !== 1) {
        return v / abDiv;
    }
    
    // Pour l'année (periodIdx === 4), multiplier par 12
    return periodIdx === 4 ? v * 12 : v;
}

/**
 * Calcule l'abonnement TTC pour une période donnée
 * @param {Object} userData - Options utilisateur
 * @param {number} periodIdx - Index de la période (0-4)
 * @returns {number} Montant TTC de l'abonnement
 */
export function getAbonnementTTC(userData, periodIdx) {
    const v = Number(userData.abonnementTTC ?? userData.abonnementttc ?? 0);
    const { abDiv } = PERIODS[periodIdx];
    
    if (abDiv !== 1) {
        return v / abDiv;
    }
    
    return periodIdx === 4 ? v * 12 : v;
}

/**
 * Récupère les tarifs selon le type de contrat
 * @param {Object} userData - Options utilisateur
 * @returns {Object} { tarifHT, tarifTTC }
 */
export function getTarifs(userData) {
    const typeContrat = userData.typeContrat || 'fixe';
    
    if (typeContrat === 'fixe') {
        return {
            tarifHT: Number(userData.prix_ht ?? userData.prixht ?? userData.prixHT ?? 0),
            tarifTTC: Number(userData.prix_ttc ?? userData.prixttc ?? userData.prixTTC ?? 0)
        };
    } else {
        // HP/HC - utiliser tarif HP par défaut pour les calculs
        return {
            tarifHT: Number(userData.prix_ht_hp ?? userData.prixhthp ?? userData.prixHTHP ?? 0),
            tarifTTC: Number(userData.prix_ttc_hp ?? userData.prixttchp ?? userData.prixTTCHP ?? 0)
        };
    }
}

/**
 * Calcule le coût total pour une période
 * @param {number} kwh - Consommation en kWh
 * @param {Object} userData - Options utilisateur
 * @param {number} periodIdx - Index de la période
 * @returns {Object} { coutHT, coutTTC, totalHT, totalTTC }
 */
export function calculatePeriodCost(kwh, userData, periodIdx) {
    const { tarifHT, tarifTTC } = getTarifs(userData);
    const abonnementHT = getAbonnementHT(userData, periodIdx);
    const abonnementTTC = getAbonnementTTC(userData, periodIdx);
    
    const coutHT = kwh * tarifHT;
    const coutTTC = kwh * tarifTTC;
    const totalHT = coutHT + abonnementHT;
    const totalTTC = coutTTC + abonnementTTC;
    
    return { coutHT, coutTTC, totalHT, totalTTC };
}

